#!/usr/bin/env node
const bs = require('browser-sync').create();
const { join } = require('path');

module.exports = function dev(port) {

  const build = require('../build/index').default;

  /**
   * Run the build process once before starting the dev server
   */
  build(true, () => {
    /**
     * Using BrowserSync to create a live server
     */
    bs.init({
      server: join(process.cwd(), 'dist'),
      port,
      snippetOptions: {
        rule: {
          match: /<!-- browsersync -->/i,
          fn: (snippet, match) => snippet + match
        }
      },
      notify: false
    });
  });

  /**
   * Watch for the changes in the project root
   */
  bs.watch(process.cwd(), {
    ignored: [join(process.cwd(), 'dist'), join(process.cwd(), 'node_modules')]
  })
  .on('change', (e, file) => 
    // Rebuild the files in devMode
    build(true, () => bs.reload())
  );

}